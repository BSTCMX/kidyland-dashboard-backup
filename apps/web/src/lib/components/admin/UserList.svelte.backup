<script lang="ts">
  /**
   * UserList component - Displays users in a table with filters and pagination.
   */
  import { onMount } from "svelte";
  import { Button } from "@kidyland/ui";
  import type { User } from "@kidyland/shared/types";
  import {
    usersStore,
    filteredUsers,
    fetchUsers,
    setSearchFilter,
    setRoleFilter,
    clearFilters,
    activateUser,
    deactivateUser,
  } from "$lib/stores/users";
  import { hasRole, hasAnyRole, user } from "$lib/stores/auth";
  import { page } from "$app/stores";
  import UserForm from "./UserForm.svelte";
  import UserDeleteConfirm from "./UserDeleteConfirm.svelte";
  import UserChangePasswordModal from "./UserChangePasswordModal.svelte";
  import LoadingSpinner from "./LoadingSpinner.svelte";
  import ErrorBanner from "./ErrorBanner.svelte";
  import { 
    Users, 
    UserPlus, 
    Edit, 
    Key, 
    Pause, 
    Trash2, 
    Search, 
    X,
    CheckCircle2,
    LayoutDashboard
  } from "lucide-svelte";
  import Badge from "$lib/components/shared/Badge.svelte";
  import PanelAccessSelector from "./PanelAccessSelector.svelte";

  // Reactive stores
  $: currentUser = $user;
  $: canEditBase = hasRole("super_admin");
  $: canView = hasAnyRole(["super_admin", "admin_viewer"]);
  
  // Check if we're in admin-viewer route (readonly)
  $: isReadonly = $page.url.pathname.startsWith("/admin-viewer");
  $: canEdit = canEditBase && !isReadonly;

  // Local state
  let searchInput = "";
  let roleFilter: "all" | User["role"] = "all";
  let selectedUser: User | null = null;
  let showCreateModal = false;
  let showEditModal = false;
  let showDeleteConfirm = false;
  let showPasswordModal = false;
  let showDeactivateConfirm = false;

  // Load users on mount
  onMount(() => {
    if (canView) {
      fetchUsers();
    }
  });

  // Watch for filter changes
  $: if (searchInput !== $usersStore.filters.search) {
    setSearchFilter(searchInput);
  }

  $: if (roleFilter !== $usersStore.filters.role) {
    setRoleFilter(roleFilter);
  }


  function handleSearch() {
    setSearchFilter(searchInput);
  }

  function handleClearFilters() {
    searchInput = "";
    roleFilter = "all";
    clearFilters();
  }

  function formatDate(dateString: string | null): string {
    if (!dateString) return "Nunca";
    try {
      return new Date(dateString).toLocaleDateString("es-ES", {
        year: "numeric",
        month: "short",
        day: "numeric",
      });
    } catch {
      return "Inválida";
    }
  }

  function getRoleLabel(role: User["role"]): string {
    const labels: Record<User["role"], string> = {
      super_admin: "Super Admin",
      admin_viewer: "Admin Viewer",
      recepcion: "Recepción",
      kidibar: "Kidibar",
      monitor: "Monitor",
    };
    return labels[role] || role;
  }

  // Helper function to get role badge variant (para Badge component)
  function getRoleBadgeVariant(role: User["role"]): 'success' | 'warning' | 'danger' | 'info' | 'primary' | 'secondary' {
    const roleVariants: Record<User["role"], 'success' | 'warning' | 'danger' | 'info' | 'primary' | 'secondary'> = {
      super_admin: "primary",
      admin_viewer: "info",
      recepcion: "success",
      kidibar: "warning",
      monitor: "secondary",
    };
    return roleVariants[role] || "secondary";
  }
  
  // Helper function to get status badge variant
  function getStatusBadgeVariant(isActive: boolean): 'success' | 'danger' {
    return isActive ? "success" : "danger";
  }

  async function handleActivate(id: string) {
    const result = await activateUser(id);
    if (result) {
      await fetchUsers($usersStore.pagination.page);
    }
  }

  async function handleDeactivate(id: string) {
    const result = await deactivateUser(id);
    if (result) {
      showDeactivateConfirm = false;
      selectedUser = null;
      await fetchUsers($usersStore.pagination.page);
    }
  }

  async function handleUserCreated() {
    showCreateModal = false;
    await fetchUsers($usersStore.pagination.page);
  }

  async function handleUserUpdated() {
    showEditModal = false;
    selectedUser = null;
    await fetchUsers($usersStore.pagination.page);
  }

  async function handleUserDeleted() {
    showDeleteConfirm = false;
    selectedUser = null;
    await fetchUsers($usersStore.pagination.page);
  }

  function handlePasswordChanged() {
    showPasswordModal = false;
    selectedUser = null;
  }
</script>

<div class="users-container">
  {#if !canView}
    <div class="error-banner">
      No tienes permisos para ver usuarios.
    </div>
  {:else}
    <!-- Panel Access Selector - Horizontal Top Bar (Desktop only) -->
    {#if canEdit && hasRole("super_admin")}
      <div class="panel-access-top">
        <PanelAccessSelector />
      </div>
    {/if}

    <!-- Main Content: Users Management -->
    <div class="users-main">
        <!-- Header with filters -->
        <div class="users-header">
      <h1 class="page-title">
        <Users size={32} strokeWidth={1.5} style="display: inline-block; vertical-align: middle; margin-right: 12px;" />
        Gestión de Usuarios
      </h1>
      
      {#if canEdit}
        <Button on:click={() => (showCreateModal = true)}>
          <UserPlus size={18} strokeWidth={1.5} style="display: inline-block; vertical-align: middle; margin-right: 6px;" />
          Crear Usuario
        </Button>
      {/if}
    </div>

    <!-- Filters -->
    <div class="filters-section">
      <div class="filter-group">
        <input
          type="text"
          placeholder="Buscar por username o nombre..."
          bind:value={searchInput}
          on:input={handleSearch}
          class="search-input"
        />
      </div>
      
      <div class="filter-group">
        <select bind:value={roleFilter} class="role-select">
          <option value="all">Todos los roles</option>
          <option value="super_admin">Super Admin</option>
          <option value="admin_viewer">Admin Viewer</option>
          <option value="recepcion">Recepción</option>
          <option value="kidibar">Kidibar</option>
          <option value="monitor">Monitor</option>
        </select>
      </div>
      
      <Button variant="secondary" on:click={handleClearFilters}>
        Limpiar Filtros
      </Button>
    </div>

    <!-- Error banner -->
    <ErrorBanner error={$usersStore.error} />

    <!-- Loading state -->
    {#if $usersStore.loading}
      <LoadingSpinner message="Cargando usuarios..." />
    {:else if $filteredUsers.length === 0}
      <div class="empty-state">
        <p>No se encontraron usuarios.</p>
      </div>
    {:else}
      <!-- Users table (Desktop) -->
      <div class="table-container">
        <table class="users-table">
          <thead>
            <tr>
              <th class="col-username">Username</th>
              <th class="col-name">Nombre</th>
              <th class="col-role">Rol</th>
              <th class="col-status">Estado</th>
              <th class="col-last-login">Último Login</th>
              <th class="col-created">Creado</th>
              {#if canEdit}
                <th class="col-actions">Acciones</th>
              {/if}
            </tr>
          </thead>
          <tbody>
            {#each $filteredUsers as user (user.id)}
              <tr>
                <!-- CRITICAL: Always render username cell with fallback to prevent column misalignment -->
                <td class="col-username font-mono text-sm username-cell" title={user.username || user.name || 'Sin username'}>
                  {user.username || user.name || '—'}
                </td>
                <td class="col-name">{user.name || '—'}</td>
                <td class="col-role">
                  <Badge variant={getRoleBadgeVariant(user.role)} size="sm">
                    {getRoleLabel(user.role)}
                  </Badge>
                </td>
                <td class="col-status">
                  <Badge variant={getStatusBadgeVariant(user.is_active)} size="sm">
                    {user.is_active ? "Activo" : "Inactivo"}
                  </Badge>
                </td>
                <td class="col-last-login date-cell">
                  {formatDate(user.last_login)}
                </td>
                <td class="col-created date-cell">
                  {formatDate(user.created_at)}
                </td>
                {#if canEdit}
                  <td class="col-actions actions-cell">
                    <div class="actions-group">
                      <Button
                        variant="secondary"
                        on:click={() => {
                          selectedUser = user;
                          showEditModal = true;
                        }}
                      >
                        <Edit size={16} strokeWidth={1.5} style="display: inline-block; vertical-align: middle; margin-right: 4px;" />
                        Editar
                      </Button>
                      <Button
                        variant="secondary"
                        on:click={() => {
                          selectedUser = user;
                          showPasswordModal = true;
                        }}
                      >
                        <Key size={16} strokeWidth={1.5} style="display: inline-block; vertical-align: middle; margin-right: 4px;" />
                        Password
                      </Button>
                      {#if user.is_active}
                        <Button
                          variant="secondary"
                          on:click={() => {
                            selectedUser = user;
                            showDeactivateConfirm = true;
                          }}
                        >
                          <Pause size={16} strokeWidth={1.5} style="display: inline-block; vertical-align: middle; margin-right: 4px;" />
                          Desactivar
                        </Button>
                      {:else}
                        <Button
                          variant="secondary"
                          on:click={() => {
                            selectedUser = user;
                            handleActivate(user.id);
                          }}
                        >
                          ▶️ Activar
                        </Button>
                      {/if}
                      <Button
                        variant="danger"
                        on:click={() => {
                          selectedUser = user;
                          showDeleteConfirm = true;
                        }}
                      >
                        <Trash2 size={16} strokeWidth={1.5} style="display: inline-block; vertical-align: middle; margin-right: 4px;" />
                        Eliminar
                      </Button>
                    </div>
                  </td>
                {/if}
              </tr>
            {/each}
          </tbody>
        </table>
      </div>

      <!-- Users cards (Mobile) -->
      <div class="users-cards">
        {#each $filteredUsers as user (user.id)}
          <div class="user-card">
            <div class="user-card-header">
              <h3 class="user-card-title">{user.name}</h3>
              <Badge variant={getRoleBadgeVariant(user.role)} size="sm">
                {getRoleLabel(user.role)}
              </Badge>
            </div>
            <div class="user-card-body">
              <div class="user-card-row">
                <span class="user-card-label">Username:</span>
                <span class="user-card-value font-mono">{user.username}</span>
              </div>
              <div class="user-card-row">
                <span class="user-card-label">Estado:</span>
                <span class="status-badge {user.is_active ? 'active' : 'inactive'}">
                  {user.is_active ? "Activo" : "Inactivo"}
                </span>
              </div>
              <div class="user-card-row">
                <span class="user-card-label">Último Login:</span>
                <span class="user-card-value">{formatDate(user.last_login)}</span>
              </div>
              <div class="user-card-row">
                <span class="user-card-label">Creado:</span>
                <span class="user-card-value">{formatDate(user.created_at)}</span>
              </div>
            </div>
            {#if canEdit}
              <div class="user-card-actions">
                <Button
                  variant="secondary"
                  on:click={() => {
                    selectedUser = user;
                    showEditModal = true;
                  }}
                >
                  <Edit size={16} strokeWidth={1.5} style="display: inline-block; vertical-align: middle; margin-right: 4px;" />
                  Editar
                </Button>
                <Button
                  variant="secondary"
                  on:click={() => {
                    selectedUser = user;
                    showPasswordModal = true;
                  }}
                >
                  <Key size={16} strokeWidth={1.5} style="display: inline-block; vertical-align: middle; margin-right: 4px;" />
                  Cambiar Password
                </Button>
                {#if user.is_active}
                  <Button
                    variant="secondary"
                    on:click={() => {
                      selectedUser = user;
                      showDeactivateConfirm = true;
                    }}
                  >
                    <Pause size={16} strokeWidth={1.5} style="display: inline-block; vertical-align: middle; margin-right: 4px;" />
                    Desactivar
                  </Button>
                {:else}
                  <Button
                    variant="secondary"
                    on:click={() => {
                      selectedUser = user;
                      handleActivate(user.id);
                    }}
                  >
                    <CheckCircle2 size={16} strokeWidth={1.5} style="display: inline-block; vertical-align: middle; margin-right: 4px;" />
                    Activar
                  </Button>
                {/if}
                <Button
                  variant="danger"
                  on:click={() => {
                    selectedUser = user;
                    showDeleteConfirm = true;
                  }}
                >
                  <Trash2 size={16} strokeWidth={1.5} style="display: inline-block; vertical-align: middle; margin-right: 4px;" />
                  Eliminar
                </Button>
              </div>
            {/if}
          </div>
        {/each}
      </div>

      <!-- Pagination -->
      {#if $usersStore.pagination.hasMore}
        <div class="pagination">
          <Button
            variant="secondary"
            disabled={$usersStore.pagination.page === 1}
            on:click={() => fetchUsers($usersStore.pagination.page - 1)}
          >
            ← Anterior
          </Button>
          <span class="page-info">
            Página {$usersStore.pagination.page}
          </span>
          <Button
            variant="secondary"
            disabled={!$usersStore.pagination.hasMore}
            on:click={() => fetchUsers($usersStore.pagination.page + 1)}
          >
            Siguiente →
          </Button>
        </div>
      {/if}
    {/if}
    </div>

    <!-- Panel Access Selector - Vertical Sidebar (Mobile only) -->
    {#if canEdit && hasRole("super_admin")}
      <div class="panel-access-mobile">
        <PanelAccessSelector />
      </div>
    {/if}
  {/if}

  <!-- Modals -->
  {#if showCreateModal}
    <UserForm
      open={showCreateModal}
      on:close={() => (showCreateModal = false)}
      on:created={handleUserCreated}
    />
  {/if}

  {#if showEditModal && selectedUser}
    <UserForm
      open={showEditModal}
      user={selectedUser}
      on:close={() => {
        showEditModal = false;
        selectedUser = null;
      }}
      on:updated={handleUserUpdated}
    />
  {/if}

  {#if showDeleteConfirm && selectedUser}
    <UserDeleteConfirm
      open={showDeleteConfirm}
      user={selectedUser}
      on:close={() => {
        showDeleteConfirm = false;
        selectedUser = null;
      }}
      on:deleted={handleUserDeleted}
    />
  {/if}

  {#if showPasswordModal && selectedUser}
    <UserChangePasswordModal
      open={showPasswordModal}
      user={selectedUser}
      on:close={() => {
        showPasswordModal = false;
        selectedUser = null;
      }}
      on:changed={handlePasswordChanged}
    />
  {/if}

  {#if showDeactivateConfirm && selectedUser}
    <UserDeleteConfirm
      open={showDeactivateConfirm}
      user={selectedUser}
      action="deactivate"
      on:close={() => {
        showDeactivateConfirm = false;
        selectedUser = null;
      }}
      on:deleted={() => selectedUser && handleDeactivate(selectedUser.id)}
    />
  {/if}
</div>

<style>
  .users-container {
    padding: var(--spacing-xl);
    max-width: 1600px;
    margin: 0 auto;
    background: var(--theme-bg-primary);
    min-height: 100vh;
    width: 100%;
    max-width: 100vw; /* Ensure container doesn't exceed viewport */
    box-sizing: border-box;
    overflow-x: hidden; /* Prevent horizontal scroll on container */
  }

  /* Panel Access Selector - Horizontal Top Bar (Desktop) */
  .panel-access-top {
    display: none; /* Hidden by default (mobile) */
  }

  /* Desktop: Show horizontal top bar */
  @media (min-width: 1200px) {
    .panel-access-top {
      display: block;
      position: sticky;
      top: 0;
      z-index: 100; /* High z-index to be on top */
      margin-bottom: var(--spacing-lg);
      background: var(--theme-bg-primary);
      padding-top: var(--spacing-md);
      padding-bottom: var(--spacing-md);
    }
  }

  /* Panel Access Selector - Vertical Sidebar (Mobile) */
  .panel-access-mobile {
    display: block;
    width: 100%;
    margin-bottom: var(--spacing-xl);
    margin-top: var(--spacing-xl);
  }

  /* Desktop: Hide mobile version */
  @media (min-width: 1200px) {
    .panel-access-mobile {
      display: none;
    }
  }

  .users-main {
    width: 100%;
    min-width: 0; /* Prevent grid overflow */
  }

  .users-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: var(--spacing-xl);
    flex-wrap: wrap;
    gap: var(--spacing-md);
  }

  .page-title {
    font-family: var(--font-primary);
    font-size: var(--text-3xl);
    font-weight: 700;
    color: var(--text-primary);
  }

  .filters-section {
    display: flex;
    gap: var(--spacing-md);
    margin-bottom: var(--spacing-lg);
    flex-wrap: wrap;
  }

  .filter-group {
    flex: 1;
    min-width: 200px;
  }

  .search-input {
    width: 100%;
    padding: var(--spacing-md) var(--spacing-lg);
    border: 2px solid var(--border-primary);
    border-radius: var(--radius-lg);
    font-size: var(--text-base);
    background: var(--theme-bg-elevated);
    color: var(--text-primary);
    transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    position: relative;
  }

  .search-input::placeholder {
    color: var(--text-muted);
    opacity: 0.7;
  }

  .search-input:focus {
    outline: none;
    border-color: var(--accent-primary);
    box-shadow: 0 0 0 4px rgba(0, 147, 247, 0.15), 0 4px 12px rgba(0, 147, 247, 0.1);
    transform: translateY(-1px);
  }

  .search-input:hover:not(:focus) {
    border-color: var(--border-secondary);
    box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);
  }

  .role-select {
    width: 100%;
    padding: var(--spacing-md) var(--spacing-lg);
    border: 2px solid var(--border-primary);
    border-radius: var(--radius-lg);
    font-size: var(--text-base);
    background: var(--theme-bg-elevated);
    color: var(--text-primary);
    transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    cursor: pointer;
    appearance: none;
    background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='12' height='12' viewBox='0 0 12 12'%3E%3Cpath fill='%230093f7' d='M6 9L1 4h10z'/%3E%3C/svg%3E");
    background-repeat: no-repeat;
    background-position: right var(--spacing-md) center;
    padding-right: calc(var(--spacing-xl) + var(--spacing-md));
  }

  .role-select:focus {
    outline: none;
    border-color: var(--accent-primary);
    box-shadow: 0 0 0 4px rgba(0, 147, 247, 0.15), 0 4px 12px rgba(0, 147, 247, 0.1);
    transform: translateY(-1px);
  }

  .role-select:hover:not(:focus) {
    border-color: var(--border-secondary);
    box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);
  }

  .empty-state {
    text-align: center;
    padding: var(--spacing-2xl);
    color: var(--text-muted);
  }

  .table-container {
    overflow-x: visible; /* No horizontal scroll - table must fit */
    overflow-y: visible;
    border: 1px solid var(--border-primary);
    border-radius: var(--radius-xl);
    margin-bottom: var(--spacing-lg);
    background: var(--theme-bg-elevated);
    box-shadow: var(--shadow-md);
    backdrop-filter: blur(10px);
    position: relative;
    width: 100%;
    max-width: 100%;
    box-sizing: border-box; /* Include border in width calculation */
  }

  /* Desktop: Optimize for fit without horizontal scroll */
  @media (min-width: 769px) {
    .table-container {
      overflow-x: visible; /* No horizontal scroll - table must fit */
      overflow-y: visible;
      margin-bottom: var(--spacing-md);
      width: 100%;
      max-width: 100%;
      box-sizing: border-box; /* Include border in width calculation */
    }

    /* Ensure table fits container width exactly */
    /* CRITICAL: Use auto layout instead of fixed for better responsive alignment */
    .users-table {
      width: 100%;
      max-width: 100%;
      table-layout: auto !important; /* Auto layout is more stable for responsive */
      border-collapse: collapse; /* Collapse borders for cleaner look */
      border-spacing: 0; /* No spacing between cells */
      box-sizing: border-box; /* Include borders in width calculation */
    }

    /* Table rows with better spacing */
    .users-table tbody tr {
      height: auto;
      min-height: 2.5rem; /* ~40px - increased for readability */
    }

    /* Badges in table with better readability */
    .users-table :global(.badge) {
      padding: 0.25rem 0.5rem; /* Increased for readability */
      font-size: 0.75rem; /* 12px - increased from 10px */
      line-height: 1.3;
    }

    /* Border thickness */
    .users-table td {
      border-bottom-width: 1px;
    }

    .users-table th {
      border-bottom-width: 1px;
    }
  }

  .table-container::before {
    content: '';
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    height: 3px;
    background: linear-gradient(90deg, var(--accent-primary), var(--accent-success), var(--accent-warning));
    border-radius: var(--radius-xl) var(--radius-xl) 0 0;
    opacity: 0.6;
  }

  .users-table {
    width: 100%;
    border-collapse: separate;
    border-spacing: 0;
    background: transparent;
  }

  /* Desktop: Column widths using class-based selectors for reliable alignment */
  /* When canEdit is true: 11% + 15% + 12% + 9% + 13% + 14% + 16% = 100% */
  /* CRITICAL: Use class-based selectors - NO nth-child() for responsive stability */
  @media (min-width: 769px) {
    /* Column 1: Username */
    .users-table .col-username {
      width: 11% !important;
      min-width: 80px; /* Minimum readable width */
      max-width: none;
    }

    /* Column 2: Nombre */
    .users-table .col-name {
      width: 15% !important;
      min-width: 100px;
      max-width: none;
    }

    /* Column 3: Rol */
    .users-table .col-role {
      width: 12% !important;
      min-width: 80px;
      max-width: none;
    }

    /* Column 4: Estado */
    .users-table .col-status {
      width: 9% !important;
      min-width: 70px;
      max-width: none;
    }

    /* Column 5: Último Login */
    .users-table .col-last-login {
      width: 13% !important;
      min-width: 100px;
      max-width: none;
    }

    /* Column 6: Creado */
    .users-table .col-created {
      width: 14% !important;
      min-width: 100px;
      max-width: none;
    }

    /* Column 7: Acciones (only when canEdit is true) */
    .users-table .col-actions {
      width: 16% !important;
      min-width: 200px; /* Enough space for action buttons */
      max-width: none;
      overflow: visible;
    }
  }

  .users-table thead {
    background: linear-gradient(135deg, var(--theme-bg-secondary) 0%, var(--theme-bg-elevated) 100%);
    position: sticky;
    top: 0;
    z-index: 10;
  }

  .users-table th {
    padding: var(--spacing-md) var(--spacing-sm);
    text-align: left;
    font-weight: 700;
    font-size: var(--text-xs);
    color: var(--text-secondary);
    border-bottom: 2px solid var(--border-primary);
    text-transform: uppercase;
    letter-spacing: 0.1em;
    position: relative;
    white-space: nowrap;
    line-height: 1.4;
    box-sizing: border-box; /* Include padding in width calculation */
  }

  /* Desktop: Headers with better readability */
  @media (min-width: 769px) {
    .users-table th {
      padding: 0.75rem 0.625rem; /* 12px vertical, 10px horizontal - increased for readability */
      font-size: 0.75rem; /* 12px - increased from 11px */
      line-height: 1.4;
    }
  }

  .users-table th:first-child {
    border-top-left-radius: var(--radius-xl);
  }

  .users-table th:last-child {
    border-top-right-radius: var(--radius-xl);
  }

  .users-table td {
    padding: var(--spacing-md) var(--spacing-sm);
    border-bottom: 1px solid var(--border-primary);
    color: var(--text-primary);
    transition: all 0.2s ease;
    position: relative;
    word-wrap: break-word;
    box-sizing: border-box; /* Include padding in width calculation */
    line-height: 1.5;
    vertical-align: middle;
  }

  /* Desktop: Cells with better readability */
  @media (min-width: 769px) {
    .users-table td {
      padding: 0.875rem 0.625rem; /* 14px vertical, 10px horizontal - increased for readability */
      line-height: 1.5;
      font-size: 0.9375rem; /* 15px - increased from 14px for better readability */
    }
  }

  /* Desktop: Apply text truncation only to specific columns (not username, not actions) */
  @media (min-width: 769px) {
    .users-table td:not(.actions-cell):not(:first-child) {
      overflow: hidden;
      text-overflow: ellipsis;
      max-width: 100%;
    }

    /* Ensure username column never truncates */
    .users-table td:first-child {
      overflow: visible !important;
      text-overflow: clip !important;
    }
  }

  /* Username column specific styling */
  .users-table td:first-child,
  .username-cell {
    font-family: 'Courier New', monospace;
    font-size: var(--text-sm);
    color: var(--text-primary);
    white-space: nowrap;
    line-height: 1.4;
  }

  /* Desktop: Username column - ensure it's fully visible, compact */
  @media (min-width: 769px) {
    .users-table td:first-child,
    .username-cell {
      overflow: visible !important;
      text-overflow: clip;
      min-width: 0; /* No restrictive min-width */
      /* width is controlled by .col-username class - don't override */
      max-width: none; /* Allow to grow if needed */
      font-size: 0.875rem; /* 14px - increased from 13px for better readability */
      line-height: 1.4;
    }

    /* Ensure username text is visible */
    .users-table td:first-child *,
    .username-cell * {
      visibility: visible !important;
      opacity: 1 !important;
    }
  }

  .users-table tbody tr {
    transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    position: relative;
  }

  .users-table tbody tr::before {
    content: '';
    position: absolute;
    left: 0;
    top: 0;
    bottom: 0;
    width: 3px;
    background: var(--accent-primary);
    opacity: 0;
    transition: opacity 0.3s ease;
  }

  .users-table tbody tr:hover {
    background: linear-gradient(90deg, var(--theme-bg-secondary) 0%, transparent 100%);
    transform: translateX(2px);
    box-shadow: -4px 0 12px rgba(0, 147, 247, 0.1);
  }

  .users-table tbody tr:hover::before {
    opacity: 1;
  }

  .users-table tbody tr:hover td {
    color: var(--text-primary);
  }

  .users-table tbody tr:last-child td {
    border-bottom: none;
  }

  .users-table tbody tr:last-child td:first-child {
    border-bottom-left-radius: var(--radius-xl);
  }

  .users-table tbody tr:last-child td:last-child {
    border-bottom-right-radius: var(--radius-xl);
  }

  .role-badge-base {
    display: inline-block;
    padding: var(--spacing-xs) var(--spacing-md);
    border-radius: 9999px;
    font-size: var(--text-xs);
    font-weight: 600;
    text-transform: uppercase;
    letter-spacing: 0.05em;
  }

  [data-theme="dark"] .role-badge-base {
    opacity: 0.9;
  }

  .status-badge {
    display: inline-block;
    padding: var(--spacing-xs) var(--spacing-md);
    border-radius: 9999px;
    font-size: var(--text-xs);
    font-weight: 600;
    line-height: 1.3;
  }

  /* Desktop: Badges with better readability */
  @media (min-width: 769px) {
    .status-badge {
      padding: 0.375rem 0.625rem; /* 6px 10px - increased for readability */
      font-size: 0.75rem; /* 12px - increased from 11px */
      line-height: 1.3;
    }
  }

  .status-badge.active {
    background: rgba(61, 173, 9, 0.2);
    color: var(--accent-success);
  }

  [data-theme="dark"] .status-badge.active {
    background: rgba(61, 173, 9, 0.3);
  }

  .status-badge.inactive {
    background: rgba(211, 5, 84, 0.2);
    color: var(--accent-danger);
  }

  [data-theme="dark"] .status-badge.inactive {
    background: rgba(211, 5, 84, 0.3);
  }

  .actions-cell {
    white-space: nowrap;
    overflow: visible;
    position: relative;
  }

  /* Desktop: Ensure actions are fully visible */
  @media (min-width: 769px) {
    .actions-cell {
      overflow: visible;
      min-width: 0; /* No restrictive min-width - allow flexibility */
    }
  }

  .actions-group {
    display: flex;
    gap: 0.375rem; /* 6px - más compacto */
    flex-wrap: nowrap;
    align-items: center;
  }

  /* Desktop: Keep actions in a single row, more compact with tighter spacing */
  @media (min-width: 769px) {
    .actions-group {
      flex-wrap: wrap; /* Allow wrapping if needed */
      gap: 0.5rem; /* 8px - increased for better spacing */
    }

    /* Action buttons with better readability */
    .actions-group :global(button) {
      padding: 0.5rem 0.75rem; /* 8px vertical, 12px horizontal - increased for readability */
      font-size: 0.8125rem; /* 13px - increased from 12px */
      line-height: 1.3;
      min-height: auto;
      white-space: nowrap;
    }

    /* Icons in buttons */
    .actions-group :global(button) :global(svg) {
      width: 14px;
      height: 14px;
      margin-right: 0.375rem;
    }
  }

  /* Tablet: Allow wrapping if needed */
  @media (min-width: 481px) and (max-width: 768px) {
    .actions-group {
      flex-wrap: wrap;
    }
  }

  .pagination {
    display: flex;
    justify-content: center;
    align-items: center;
    gap: 1rem;
  }

  .date-cell {
    font-size: var(--text-sm);
    color: var(--text-muted);
    line-height: 1.4;
  }

  /* Desktop: Date cells with better readability */
  @media (min-width: 769px) {
    .date-cell {
      font-size: 0.875rem; /* 14px - increased from 13px */
      line-height: 1.4;
    }
  }

  .page-info {
    color: var(--text-secondary);
    font-weight: 500;
    font-size: var(--text-sm);
  }

  /* Mobile: Convert table to cards */
  @media (max-width: 768px) {
    .users-container {
      padding: var(--spacing-md);
    }

    .users-header {
      flex-direction: column;
      align-items: stretch;
    }

    .filters-section {
      flex-direction: column;
    }

    .filter-group {
      min-width: 100%;
    }

    /* Hide table on mobile, show cards instead */
    .table-container {
      display: none;
    }

    .users-cards {
      display: grid;
      grid-template-columns: 1fr;
      gap: var(--spacing-md);
    }

    .user-card {
      background: var(--theme-bg-elevated);
      border: 2px solid var(--border-primary);
      border-radius: var(--radius-xl);
      padding: var(--spacing-lg);
      box-shadow: var(--shadow-md);
      transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
      position: relative;
      overflow: hidden;
    }

    .user-card::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      height: 3px;
      background: linear-gradient(90deg, var(--accent-primary), var(--accent-success));
      opacity: 0;
      transition: opacity 0.3s ease;
    }

    .user-card:hover {
      transform: translateY(-2px);
      box-shadow: var(--shadow-lg);
      border-color: var(--accent-primary);
    }

    .user-card:hover::before {
      opacity: 1;
    }

    .user-card-header {
      display: flex;
      justify-content: space-between;
      align-items: flex-start;
      margin-bottom: var(--spacing-md);
      padding-bottom: var(--spacing-md);
      border-bottom: 1px solid var(--border-primary);
    }

    .user-card-title {
      font-family: var(--font-primary);
      font-size: var(--text-lg);
      font-weight: 700;
      color: var(--text-primary);
      margin: 0;
    }

    .user-card-body {
      display: flex;
      flex-direction: column;
      gap: var(--spacing-sm);
      margin-bottom: var(--spacing-md);
    }

    .user-card-row {
      display: flex;
      justify-content: space-between;
      align-items: center;
      font-size: var(--text-sm);
    }

    .user-card-label {
      color: var(--text-secondary);
      font-weight: 500;
    }

    .user-card-value {
      color: var(--text-primary);
    }

    .user-card-actions {
      display: flex;
      flex-direction: column;
      gap: var(--spacing-sm);
      margin-top: var(--spacing-md);
      padding-top: var(--spacing-md);
      border-top: 1px solid var(--border-primary);
    }

    .user-card-actions .btn {
      width: 100%;
      min-height: 48px;
    }

    .actions-group {
      flex-direction: column;
      width: 100%;
    }

    .actions-group .btn {
      width: 100%;
      min-height: 48px;
    }
  }

  /* Desktop: Show table, hide cards */
  @media (min-width: 769px) {
    .users-cards {
      display: none;
    }

    .table-container {
      display: block;
    }
  }

  /* Tablet: Scrollable table */
  @media (min-width: 481px) and (max-width: 1023px) {
    .table-container {
      overflow-x: auto;
      -webkit-overflow-scrolling: touch;
    }

    .users-table {
      min-width: 800px;
    }
  }
</style>

